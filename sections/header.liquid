'use client';
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useLanguage } from '@/context/LanguageContext';
import { useTheme } from '@/context/ThemeContext';
import { Sun, Moon, Globe, Menu, X, User, ShoppingCart } from 'lucide-react';
import { useIsMobile } from '@/hooks/use-mobile';
import Image from 'next/image';

export default function Header() {
  const { language, setLanguage, t } = useLanguage();
  const { theme, setTheme } = useTheme();
  const [isScrolled, setIsScrolled] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const isMobile = useIsMobile();
  const pathname = usePathname();

  const toggleLanguage = useCallback(() => {
    setLanguage(prev => prev === 'en' ? 'ar' : 'en');
  }, [setLanguage]);

  const toggleTheme = useCallback(() => {
    setTheme(prev => prev === 'light' ? 'dark' : 'light');
  }, [setTheme]);
  
  const toggleMenu = useCallback(() => {
    setIsMenuOpen(prev => !prev);
  }, []);

  const closeMenu = useCallback(() => {
    setIsMenuOpen(false);
  }, []);

  useEffect(() => {
    let ticking = false;
    const handleScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          setIsScrolled(window.scrollY > 10);
          ticking = false;
        });
        ticking = true;
      }
    };
    
    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  useEffect(() => {
    if (isMenuOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isMenuOpen]);

  useEffect(() => {
    setIsMenuOpen(false);
  }, [pathname]);

  const isHomePage = pathname === '/';
  
  const headerClasses = useMemo(() => 
    `fixed top-0 left-0 right-0 z-50 transition-all duration-300 ${
      isScrolled || !isHomePage 
        ? 'bg-white/80 dark:bg-black/80 backdrop-blur-sm shadow-md' 
        : 'bg-transparent'
    }`,
    [isScrolled, isHomePage]
  );
  
  const linkColorClass = useMemo(() => 
    isScrolled || !isHomePage 
      ? 'text-gray-800 dark:text-brand-gold' 
      : 'text-white dark:text-brand-gold',
    [isScrolled, isHomePage]
  );

  const activeLinkClass = 'text-brand-pink dark:text-white font-bold';

  // Navigation links data - memoized
  const navigationLinks = useMemo(() => [
    { href: '/', label: t.header.home, match: pathname === '/' },
    { href: '/shop', label: t.header.shop, match: pathname.startsWith('/shop') },
    { href: '/about', label: t.header.about, match: pathname === '/about' },
    { href: '/contact', label: t.header.contact, match: pathname === '/contact' },
    { href: '/tracking', label: 'Track Order', match: pathname === '/tracking' }
  ], [pathname, t]);

  const logoSrc = useMemo(() => {
    const goldLogo = "https://i.ibb.co/xSkmkymJ/9-1.png";
    const whiteLogo = "https://i.ibb.co/xSkmkymJ/9-1.png";
    
    if (theme === 'dark') return goldLogo;
    if (isScrolled || !isHomePage) return goldLogo;
    return whiteLogo;
  }, [theme, isScrolled, isHomePage]);

  return (
    <header className={headerClasses} role="banner">
      <div className="container mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-20">
          
          {/* Desktop Navigation */}
          <nav 
            className="hidden md:flex md:items-center md:space-x-8 w-1/3" 
            aria-label="Main navigation"
          >
            {navigationLinks.map(link => (
              <Link 
                key={link.href}
                href={link.href} 
                className={`${linkColorClass} hover:text-brand-pink dark:hover:text-white transition-colors ${
                  link.match ? activeLinkClass : ''
                }`}
                aria-current={link.match ? 'page' : undefined}
              >
                {link.label}
              </Link>
            ))}
          </nav>

          {/* Logo */}
          <div className="flex-1 flex justify-center md:w-1/3">
            <Link href="/" aria-label="LAVIE Home">
              <Image
                src={logoSrc}
                alt="LAVIE Logo"
                width={56}
                height={56}
                className="h-14 w-14 object-contain drop-shadow-[0_2px_2px_rgba(0,0,0,0.7)]"
                priority
                quality={90}
              />
            </Link>
          </div>

          {/* Actions */}
          <div className="flex items-center justify-end space-x-3 md:space-x-4 w-1/3">
            <button 
              onClick={toggleLanguage} 
              className={`${linkColorClass} hover:text-brand-pink dark:hover:text-white transition-colors`}
              aria-label={`Switch to ${language === 'en' ? 'Arabic' : 'English'}`}
            >
              <Globe size={20} aria-hidden="true" />
            </button>
            
            <button 
              onClick={toggleTheme} 
              className={`${linkColorClass} hover:text-brand-pink dark:hover:text-white transition-colors`}
              aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
            >
              {theme === 'light' ? <Moon size={20} aria-hidden="true" /> : <Sun size={20} aria-hidden="true" />}
            </button>
            
            <Link 
              href="/cart" 
              className={`${linkColorClass} hover:text-brand-pink dark:hover:text-white transition-colors`}
              aria-label="Shopping cart"
            >
              <ShoppingCart size={20} aria-hidden="true" />
            </Link>
            
            {isMobile ? (
              <button 
                onClick={toggleMenu} 
                className={`${linkColorClass} z-50 relative`}
                aria-label={isMenuOpen ? "Close menu" : "Open menu"}
                aria-expanded={isMenuOpen}
                aria-controls="mobile-menu"
              >
                {isMenuOpen ? <X size={28} aria-hidden="true" /> : <Menu size={28} aria-hidden="true" />}
              </button>
            ) : (
              <Link 
                href="/login" 
                className={`${linkColorClass} hover:text-brand-pink dark:hover:text-white transition-colors`}
                aria-label="Login"
              >
                <User size={20} aria-hidden="true" />
              </Link>
            )}
          </div>
        </div>
      </div>
      
      {/* Mobile Menu */}
      {isMobile && (
        <>
          {isMenuOpen && (
            <div 
              className="fixed inset-0 bg-black/50 z-30 backdrop-blur-sm"
              onClick={closeMenu}
              aria-hidden="true"
            />
          )}
          
          <nav
            id="mobile-menu"
            className={`fixed inset-y-0 right-0 w-full max-w-sm bg-white dark:bg-black z-40 transform ${
              isMenuOpen ? 'translate-x-0' : 'translate-x-full'
            } transition-transform duration-300 ease-in-out shadow-2xl`}
            aria-label="Mobile navigation"
            aria-hidden={!isMenuOpen}
          >
            <div className="flex flex-col items-center justify-center h-full space-y-6 text-xl pt-20 px-6">
              {navigationLinks.map(link => (
                <Link 
                  key={link.href}
                  href={link.href} 
                  className={`text-gray-800 dark:text-brand-gold hover:text-brand-pink dark:hover:text-white transition-colors ${
                    link.match ? activeLinkClass : ''
                  }`}
                  onClick={closeMenu}
                  aria-current={link.match ? 'page' : undefined}
                >
                  {link.label}
                </Link>
              ))}
              
              <Link 
                href="/login" 
                className="flex items-center gap-2 text-gray-800 dark:text-brand-gold hover:text-brand-pink dark:hover:text-white transition-colors"
                onClick={closeMenu}
              >
                <User size={24} aria-hidden="true" />
                <span>{t.header.login}</span>
              </Link>
            </div>
          </nav>
        </>
      )}
    </header>
  );
}
